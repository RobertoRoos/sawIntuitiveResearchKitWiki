# Introduction

Acronyms used in this page are defined in [Frequently Asked Questions](/jhu-dvrk/sawIntuitiveResearchKit/wiki/FAQ).

There are two different groups of users for the dVRK mechatronics and software, those with a da Vinci Research Kit provided by Intuitive Surgical (2 MTMs, 2PSMs, stereo display and foot pedals) and those with a full decommissioned da Vinci system.  This page addresses some issues specific to the later group.

It is important to notice that is a few hardware features from the full da Vinci system that are not currently supported by the dVRK mechatronics and software:
* Video pipeline and messages in stereo display
* Audio pipeline
* Control panel and switches on the master console arm rest (on/off, scaling, arm pairing, ...)
* Height adjustment for the stereo display
* Head sensor

The dVRK mechatronics and software support the camera manipulator (ECM) and setup joints:
* For the ECM, we use a FPGA-QLA based PSM controller with a special configuration (XML file) to support the brakes.
* For the setup joints, we use the a single FPGA-QLA board connected to a board designed by Intuitive Surgical (dSIB) which can interface with all 4 setup joints.
 
You will be able to switch back and forth between the mechatronics from ISI and the dVRK controllers but this requires to unplug a few cables.  The user has to connect the arms, setup joints and foot pedal directly to the dVRK controllers:
* MTM cables can be found on the back of the master console, grey plastic covers need to be removed.
* Foot pedal cable can be found on the front of the master console, under the stereo display and the cover needs to be removed.  This cable is rather short so one might consider investing in an extension cable.
* On the patient side, both setup joints and arms need to be unplugged from the back of the cart to be connected to the controllers.  The long cables normally used to connect the patient cart to the master console are not used.

## ECM

The main difference between the ECM and the PSM is the active brakes on the first 3 joints.  Make sure you use a PSM controller, i.e. a controller with a single 24V motor power supply for both FPGA-QLA.  Controllers for the MTM have two power supplies for the motors, a 24V for the first 4 axis and a 12V for the last 4 axis.  On your controller, set the board IDs to 4 and 5 (see [XML configuration](/jhu-dvrk/sawIntuitiveResearchKit/wiki/XMLConfig)).

### XML configuration

A default configuration file will be generated by our Matlab config generator.  You'll need the ECM calibration file (`.cal`) and make sure you select "ECM" for the hardware type (see [XML configuration](/jhu-dvrk/sawIntuitiveResearchKit/wiki/XMLConfig)).  In the generated configuration file, pay attention to the section "AnalogBrake"
```xml
    <AnalogBrake AxisID="0" BoardID="5">
        <AmpsToBits Offset="32819" Scale="5242.88"/>
        <BitsToFeedbackAmps Offset="-6.25" Scale="0.000190738"/>
        <MaxCurrent Unit="A" Value="0.300"/>
        <ReleaseCurrent Unit="A" Value="0.300"/>
        <ReleaseTime Value="2.000"/>
        <ReleasedCurrent Unit="A" Value="0.080"/>
        <EngagedCurrent Unit="A" Value="0.000"/>
    </AnalogBrake>
```
There are 4 important values that will need to be tweaked to your hardware:
* ReleaseCurrent: current required to release the brakes - the "Unit" field in the XML file is not read by the software, replacing it by `mA` won't have any effect so make sure the specify the `Value` in amperes.
* ReleaseTime: amount of time you need to keep the current high to release the brakes (in seconds).
* ReleasedCurrent: current required to maintain the brakes released.  This value should be significantly lower than the current to initially release the brakes.
* EngagedCurrent: current required to engage (lock) the brakes.  On the ECM, always zero.

Please note that the values provided on this page are hardware specific and you must adjust them to your system.  Ideally, you want to find the lowest possible current that still work reliably on your hardware.

### Current feedback calibration

Current calibration needs to be performed for both the actuators and the brakes.  Once you have generated the ECM XML configuration files, follow instructions from [Calibration](/jhu-dvrk/sawIntuitiveResearchKit/wiki/Calibration).  The main difference for the ECM is that you need to follow the procedure twice, once without the `-b` option and once with the `-b` option.

### Adjusting brake settings

This is a **VERY IMPORTANT PROCEDURE**.  At that point, we don't have a utility program the automatically adjust the parameters specific to the brakes, namely the 4 following values in the XML file:
* `ReleaseCurrent` and `ReleaseTime`
* `ReleasedCurrent`
* `EngageCurrent`, though this one is easy, it should be set to 0.

For this procedure we will use the [sawRobotIO1394QtConsole](/jhu-dvrk/sawIntuitiveResearchKit/wiki/Examples#2-sawrobotio1394qtconsole) program along with the ECM XML configuration file for your arm.  You will need to manually edit the XML file and between changes, test using the `sawRobotIO1394QtConsole` program.

1. The first step is to determine the `ReleaseCurrent`.
   * In the XML file, set all the `ReleasedCurrent` (NOTE: release**D** current) to zero and the `ReleaseTime` to 60 seconds.  Start from a low value for the 3 `ReleaseCurrent` values (~0.1 for 100 mA).
   * Start the `sawRobotIO1394QtConsole` and `Enable All` to power the actuators and brakes.
   * Press the `Release` button for the brakes.  You should see the requested current move to the value set in the XML file and a current feedback close to it.  After 60 seconds (or whatever `ReleaseTime` you've set in the XML file), current should go back to `ReleasedCurrent` value (i.e. 0 for now).
   * During these 60 seconds, try to move the ECM, joint by joint.  If you stand close to the arm, you shouldn't even hear a click if the brakes get released.
   * If a given brake is not released, quit the application, increase the value of `ReleaseCurrent` for the corresponding joint in the XML file and try again.

2. Once you've found the proper values for `ReleaseCurrent`, you can decrease the `ReleaseTime` value to 2.0.

3. The last step is to find the lowest possible for `ReleasedCurrent`.  This is the current applied `ReleaseTime` seconds after `ReleaseCurrent` to keep the brakes from re-engaging.  It's **IMPORTANT** to find the lowest possible value.  Again, start from a low value and increase progressively until you find settings such that the brakes stay released.
 
### dMIB modification for setup joints switch

The setup joint switch/button on the ECM is not using the same digital input as the setup joint switch on the PSMs.  This was unfortunately discovered after the dMIB were designed.  In other words, you need to hack the dMIB to short a couple pins.  You will need someone in house who can do some soldering.
 
## Setup joints

**TBD**